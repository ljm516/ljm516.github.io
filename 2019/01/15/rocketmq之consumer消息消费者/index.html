<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ljming的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="body {   max-width: 980px;   border: 1px solid #ddd;   outline: 1300px solid #fff;   margin: 16px auto; }  body .markdown-body {   padding: 45px; }  @font-face {   font-family: fontawesome-mini;   s">
<meta property="og:type" content="article">
<meta property="og:title" content="ljming的博客">
<meta property="og:url" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/index.html">
<meta property="og:site_name" content="ljming的博客">
<meta property="og:description" content="body {   max-width: 980px;   border: 1px solid #ddd;   outline: 1300px solid #fff;   margin: 16px auto; }  body .markdown-body {   padding: 45px; }  @font-face {   font-family: fontawesome-mini;   s">
<meta property="og:locale" content="zh">
<meta property="og:image" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/flow_controller.jpg">
<meta property="og:image" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/process_consumer_result.jpg">
<meta property="og:image" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/consumer_send_back.jpg">
<meta property="og:image" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/reconsumer_delay.jpg">
<meta property="og:updated_time" content="2019-01-15T03:02:02.699Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ljming的博客">
<meta name="twitter:description" content="body {   max-width: 980px;   border: 1px solid #ddd;   outline: 1300px solid #fff;   margin: 16px auto; }  body .markdown-body {   padding: 45px; }  @font-face {   font-family: fontawesome-mini;   s">
<meta name="twitter:image" content="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/flow_controller.jpg">
  
    <link rel="alternate" href="/atom.xml" title="ljming的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ljming的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">程序人生</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ljm516.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-rocketmq之consumer消息消费者" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/15/rocketmq之consumer消息消费者/" class="article-date">
  <time datetime="2019-01-15T03:02:02.698Z" itemprop="datePublished">2019-01-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="date" content="2019-01-06 22:38:33">
<meta name="tags" content="">
<meta name="categories" content="消息队列"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAABE0AA8AAAAAHWwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABWAAAADsAAABUIIslek9TLzIAAAGUAAAAQwAAAFY3d1HZY21hcAAAAdgAAACqAAACOvWLi0FjdnQgAAAChAAAABMAAAAgBtX/BGZwZ20AAAKYAAAFkAAAC3CKkZBZZ2FzcAAACCgAAAAIAAAACAAAABBnbHlmAAAIMAAABdQAAAjkYT9TNWhlYWQAAA4EAAAAMwAAADYQ6WvNaGhlYQAADjgAAAAfAAAAJAc6A1pobXR4AAAOWAAAACAAAAA0Kmz/7mxvY2EAAA54AAAAHAAAABwQPBJubWF4cAAADpQAAAAgAAAAIAEHC/NuYW1lAAAOtAAAAYQAAALxhQT4h3Bvc3QAABA4AAAAfgAAAMS3SYh9cHJlcAAAELgAAAB6AAAAhuVBK7x4nGNgZGBg4GIwYLBjYHJx8wlh4MtJLMljkGJgYYAAkDwymzEnMz2RgQPGA8qxgGkOIGaDiAIAJjsFSAB4nGNgZHZmnMDAysDAVMW0h4GBoQdCMz5gMGRkAooysDIzYAUBaa4pDA4Pwz+yMwf9z2KIYg5imAYUZgTJAQDcoQvQAHic7ZHNDYJAFIRnBXf94cDRIiyCKkCpwFCPJ092RcKNDoYKcN4+EmMPvpdvk539zQyAPYBCXEUJhBcCrJ5SQ9YLnLJe4qF5rdb+uWPDngNHTkta101pNyWa8lMhn6xx2dqUnW4q9YOIhAOOeueMSgsR/6ry+P7O5s6xVNg4chBsHUuFnWNJ8uZYwrw7chrsHXkODo7cB0dHOYCTY8kv0VE2WJKD6gOlWjsxAAB4nGNgQAMSEMgc9D8LhAESbAPdAHicrVZpd9NGFB15SZyELCULLWphxMRpsEYmbMGACUGyYyBdnK2VoIsUO+m+8Ynf4F/zZNpz6Dd+Wu8bLySQtOdwmpOjd+fN1czbZRJaktgL65GUmy/F1NYmjew8CemGTctRfCg7eyFlisnfBVEQrZbatx2HREQiULWusEQQ+x5ZmmR86FFGy7akV03KLT3pLlvjQb1V334aOsqxO6GkZjN0aD2yJVUYVaJIpj1S0qZlqPorSSu8v8LMV81QwohOImm8GcbQSN4bZ7TKaDW24yiKbLLcKFIkmuFBFHmU1RLn5IoJDMoHzZDyyqcR5cP8iKzYo5xWsEu20/y+L3mndzk/sV9vUbbkQB/Ijuzg7HQlX4RbW2HctJPtKFQRdtd3QmzZ7FT/Zo/ymkYDtysyvdCMYKl8hRArP6HM/iFZLZxP+ZJHo1qykRNB62VO7Es+gdbjiClxzRhZ0N3RCRHU/ZIzDPaYPh788d4plgsTAngcy3pHJZwIEylhczRJ2jByYCVliyqp9a6YOOV1WsRbwn7t2tGXzmjjUHdiPFsPHVs5UcnxaFKnmUyd2knNoykNopR0JnjMrwMoP6JJXm1jNYmVR9M4ZsaERCICLdxLU0EsO7GkKQTNoxm9uRumuXYtWqTJA/Xco/f05la4udNT2g70s0Z/VqdiOtgL0+lp5C/xadrlIkXp+ukZfkziQdYCMpEtNsOUgwdv/Q7Sy9eWHIXXBtju7fMrqH3WRPCkAfsb0B5P1SkJTIWYVYhWQGKta1mWydWsFqnI1HdDmla+rNMEinIcF8e+jHH9XzMzlpgSvt+J07MjLj1z7UsI0xx8m3U9mtepxXIBcWZ5TqdZlu/rNMfyA53mWZ7X6QhLW6ejLD/UaYHlRzodY3lBC5p038GQizDkAg6QMISlA0NYXoIhLBUMYbkIQ1gWYQjLJRjC8mMYwnIZhrC8rGXV1FNJ49qZWAZsQmBijh65zEXlaiq5VEK7aFRqQ54SbpVUFM+qf2WgXjzyhjmwFkiXyJpfMc6Vj0bl+NYVLW8aO1fAsepvH472OfFS1ouFPwX/1dZUJb1izcOTq/Abhp5sJ6o2qXh0TZfPVT26/l9UVFgL9BtIhVgoyrJscGcihI86nYZqoJVDzGzMPLTrdcuan8P9NzFCFlD9+DcUGgvcg05ZSVnt4KzV19uy3DuDcjgTLEkxN/P6VvgiI7PSfpFZyp6PfB5wBYxKZdhqA60VvNknMQ+Z3iTPBHFbUTZI2tjOBIkNHPOAefOdBCZh6qoN5E7hhg34BWFuwXknXKJ6oyyH7kXs8yik/Fun4kT2qGiMwLPZG2Gv70LKb3EMJDT5pX4MVBWhqRg1FdA0Um6oBl/G2bptQsYO9CMqdsOyrOLDxxb3lZJtGYR8pIjVo6Of1l6iTqrcfmYUl++dvgXBIDUxf3vfdHGQyrtayTJHbQNTtxqVU9eaQ+NVh+rmUfW94+wTOWuabronHnpf06rbwcVcLLD2bQ7SUiYX1PVhhQ2iy8WlUOplNEnvuAcYFhjQ71CKjf+r+th8nitVhdFxJN9O1LfR52AM/A/Yf0f1A9D3Y+hyDS7P95oTn2704WyZrqIX66foNzBrrblZugbc0HQD4iFHrY64yg18pwZxeqS5HOkh4GPdFeIBwCaAxeAT3bWM5lMAo/mMOT7A58xh0GQOgy3mMNhmzhrADnMY7DKHwR5zGHzBnHWAL5nDIGQOg4g5DJ4wJwB4yhwGXzGHwdfMYfANc+4DfMscBjFzGCTMYbCv6dYwzC1e0F2gtkFVoANTT1jcw+JQU2XI/o4Xhv29Qcz+wSCm/qjp9pD6Ey8M9WeDmPqLQUz9VdOdIfU3Xhjq7wYx9Q+DmPpMvxjLZQa/jHyXCgeUXWw+5++J9w/bxUC5AAEAAf//AA94nIVVX2hbZRQ/5/t7893s5ja9f7ouzdZ0TTqz3bRJmogbWya6bG6Cq0VbSV2ddIJjFtfIQHEig80Hda8yUN/0YQz8AyriiyD+xQd92R4HCnaCb3samnpumrpsCsLlfPf7zvedc37nL3CAtc/5W/wQZGA3tOBSY/g+TMjHmwzEoM1Q8+ZjRZY4oJhmBw5/YB6Za0yC5AkhlwA1A1yCBIBOwCII0Cj0U8BAMdUCzq05sKwkP7SlUY6fcJk4Fb/RyE79/6P5hjM/F4aZiXBoeMgzcqQ4Xi1hPqfDLG5FT+lchCVU3lYMyvuwhl1mqndQL0RsuloLywHtthLXI06OblTrhfWVnpSJ5+mwu/JdbtuN3IAnkW0LLMcRwaC7ktrlzridM6kVdyf9uO1UNBByI7JhwtG2sEwab07ORBeilWhqavJCqV0qzZTOl/7ZXQ5TbTcdcFelyGhhRDAQpdqp1FEX3w3cFTc1k9pJQkmm4ySCbSikxRP2QOfN+0tHS5MrpQuTU1Mk5nw0E5Xa0WvrOwDyGax9yB9ma6DAg82wHc43SAGTI4GjBWebOePAERFE8/AHaQpZASSTy8A4WwZiLQMQ82mFKATO0ILicRAoDm9p5P99E5b/fXG+kQYY3TYUuqmERWYoT0u/GNYL2q/4WB3LaVS+VynXsVYIcWw6DkCh3nX1D+VzlYN4LClF5yexSQos8exqZ3KVP+wtrC54u4Nznq6cq+xpMpUUnZ8FUYzE86ud0g28NOIv3Gj5/rmA3ABs7S/ywzFuQ4qyd6QxfNtiQIaEgp3w/entQg4Vcbqa16M5FfpeUB8t1+qeg7mI7cUyOe79wOk86gSxkVec4KPTX69++5x68Yubn5/F+w52z7u08sJX7fZXv8ekT/d2mILJxq6sn+SC6qEJknzLJCxyZEKwWVqYmAPBxBE/9DLeZiWHu7lcr/VytrCRuHojncNuTt9h46tmacmYisnSamdN2bZptcsmSysdVsy1PrOvOzF3xN64Rb937t/og9KHxYdcjIUqFAmIAHGHNzlns+RTPgeUYAQm9DwpNxfxbhhBHPaw3/gfTcXO2L+eJVIx5nsyGkvm9X4/f+bGkH45G0PaSjcMXTjcZyTvi3UdHoCDjQd3IDUVsgwYmUoJK/gp4JJxeRI0MKHZIkgynyIBqBTOUs6rOVCojvjZ4mCQz49ZMlMcp8QoYk6NoBfsxnJtsBohpa8iGJS+ZH7gU7NxME6cmF+t7cO9vB8d3jTWSct0ycW9ranXmolNDwmVkNnxe+8JtoztwS5rKJ0xWS95tQ/1zMYzg69MzUZnNtl1ofNbsml/OJm6f9wjRjpnu2o4MzHzn77IQkRd+1DjwMQ2pqSjGMMhyjrgTbBAKksuUm0iU7hI0aN2wOKOq7WYBSH0HGihj/jkiPxAfmwsEbfYrjMG+j3ij932Db/LV7I/xruNrhnroxjR9HRMb2nTvO0ZXOoHPk8H2ZhDPx93qcE/53sH5np/dkIP7zzhTVKdR/BAY/9ElkkR+A6lJGsqpJ4oQcTxpvBT3Kn58VkaJjgHyPEIws57xkaHh9KuVpDEpJZeMbZ5w/zBHi5NMQ4r5VphsFqID7TyB9eR4pX216c3AHxpdAwoqU9qg0ZJ6yVLKmMSz1iG2z27ifx18NkY0LPx1W/wCc2l5LrznrIsiKsqbmB78A9wIGx4tI8rjihVHJyY9pgMirenVq0yWg7Iw7eogG7ZgYM3qR9959A/fZkg6MnD/exlkmc+jWV4SB15XUR+eqC6l6ZmgPtN9z5JMfik05OV8ljylunJ4J+wA/FUaQSSKotsYsCWqaPBidBLcxkWx7XKFRIb45TGaEhjlF9uUVPqXOtcIwsXbBvfoZXIyRYFdkfnqjExH98xpnPczqzjX/uNdO1Y17Wpi5+6Ts8BXtjVFasp9KZ1mOiNbH65c5w6HgmyF2jFCZywM8mWjRc7T5Pmt0lRy7Y71+jYbpGyvwG4sH0XeJxjYGRgYADiwBB/53h+m68M3MwvgCIM1z5N/g6j///9v5H5BbMnkMvBwAQSBQCIcA9gAHicY2BkYGAO+p8FJF/8//v/F/MLBqAICuAFALYQB5kAeJxjfsHAwLwAiCNB+P9fbJjJmoGBMRUo/wKCAfO2EnQAAAAAANoBXgGcAgICVALaA1IDvAPkBAYEPARyAAEAAAANAF0ABAAAAAAAAgAUACQAcwAAAG4LcAAAAAB4nHWRzWrCQBSFT+pPqUIXLXTTzayKUohGKIibCoLuhbrrYtTRxCYZmYyKyz5Fd32HvlDfoO/QkziIFJtw9bvnnpl7ZwLgBt/wcHieGAf2UGd24Atcou+4RH3kuEweO66QXx1XyaHjGh6ROa7jFp/cwStfMVvhy7GHO+/e8QWuvcBxifqz4zL5xXGF/Oa4Sn53XMPE+3Bcx4P3M9DrvYmWoRWNQVN02kFXTPdCU4pSGQu5saE2meiLhU6timPtz3SSs9ypTCdqrJabWJoT5QQnymSRTkXgt0/UkUqVkVbN807ZdtmxdiEWRidi6HqItdErNbN+aO2612qd9sYAGmvsYRBhyUu0EGhQbfK/gzYCdElTOgSdB1eEFBIxFYkNV4RFJWPeZyyYpVQVHTHZx4y/yVGX2LGWFZri51TccUOn5B7nPefVCSPvGhVVwUl9znveO2KkhV8Wk82PZ8qwZf8OVcu1+fSmWCMw/HMOwXvKaysqM+p+cVuWag8tvv+c+xdd+4+teJxtjUEOwiAURJla24KliQfhUA2g/Sl+CKXx+loNrpzVezOLEY34Ron/0WhwQoszOvQYIKFwwQiNSbSBeO2SZ0tBP4j3zVjKNng32ZmtD1VVXCuOiw/pJ8S3WOU6l+K5UOTaDC4+2TjKMtN9KQf1ezLx/Sg/00FCvABHhjDjAAB4nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjEwMmiBGJu5mBg5ICw+BjCLzWkX0wGgNCeQze60i8EBwmZmcNmowtgRGLHBoSNiI3OKy0Y1EG8XRwMDI4tDR3JIBEhJJBBs5mFi5NHawfi/dQNL70YmBhcADHYj9AAA) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* Multimarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*github*/
.codehilite {background-color:#fff;color:#333333;}
.codehilite .hll {background-color:#ffffcc;}
.codehilite .c{color:#999988;font-style:italic}
.codehilite .err{color:#a61717;background-color:#e3d2d2}
.codehilite .k{font-weight:bold}
.codehilite .o{font-weight:bold}
.codehilite .cm{color:#999988;font-style:italic}
.codehilite .cp{color:#999999;font-weight:bold}
.codehilite .c1{color:#999988;font-style:italic}
.codehilite .cs{color:#999999;font-weight:bold;font-style:italic}
.codehilite .gd{color:#000000;background-color:#ffdddd}
.codehilite .ge{font-style:italic}
.codehilite .gr{color:#aa0000}
.codehilite .gh{color:#999999}
.codehilite .gi{color:#000000;background-color:#ddffdd}
.codehilite .go{color:#888888}
.codehilite .gp{color:#555555}
.codehilite .gs{font-weight:bold}
.codehilite .gu{color:#800080;font-weight:bold}
.codehilite .gt{color:#aa0000}
.codehilite .kc{font-weight:bold}
.codehilite .kd{font-weight:bold}
.codehilite .kn{font-weight:bold}
.codehilite .kp{font-weight:bold}
.codehilite .kr{font-weight:bold}
.codehilite .kt{color:#445588;font-weight:bold}
.codehilite .m{color:#009999}
.codehilite .s{color:#dd1144}
.codehilite .n{color:#333333}
.codehilite .na{color:teal}
.codehilite .nb{color:#0086b3}
.codehilite .nc{color:#445588;font-weight:bold}
.codehilite .no{color:teal}
.codehilite .ni{color:purple}
.codehilite .ne{color:#990000;font-weight:bold}
.codehilite .nf{color:#990000;font-weight:bold}
.codehilite .nn{color:#555555}
.codehilite .nt{color:navy}
.codehilite .nv{color:teal}
.codehilite .ow{font-weight:bold}
.codehilite .w{color:#bbbbbb}
.codehilite .mf{color:#009999}
.codehilite .mh{color:#009999}
.codehilite .mi{color:#009999}
.codehilite .mo{color:#009999}
.codehilite .sb{color:#dd1144}
.codehilite .sc{color:#dd1144}
.codehilite .sd{color:#dd1144}
.codehilite .s2{color:#dd1144}
.codehilite .se{color:#dd1144}
.codehilite .sh{color:#dd1144}
.codehilite .si{color:#dd1144}
.codehilite .sx{color:#dd1144}
.codehilite .sr{color:#009926}
.codehilite .s1{color:#dd1144}
.codehilite .ss{color:#990073}
.codehilite .bp{color:#999999}
.codehilite .vc{color:teal}
.codehilite .vg{color:teal}
.codehilite .vi{color:teal}
.codehilite .il{color:#009999}
.codehilite .gc{color:#999;background-color:#EAF2F5}
</style><title>rocketmq之consumer消息消费者</title></head><body><article class="markdown-body"><ul>
<li>RocketMQ</li>
<li>consumer</li>
</ul>
<hr>
<p>RocketMQ 之消息消费者 consumer 源码解析。</p>
<a id="more"></a>

<h2 id="_1">前景回顾<a class="headerlink" href="#_1" title="Permanent link"></a></h2>
<p><strong><a href="/2019/01/03/rocketmq之producer消息发送者/" title="RocketMQ学习Part2之Producer">RocketMQ学习Part2之Producer</a></strong>
<strong><a href="/2018/12/28/rocketmq之broker源码学习/" title="RocketMQ学习Part1之Broker">RocketMQ学习Part1之Broker</a></strong></p>
<h2 id="_2">概述<a class="headerlink" href="#_2" title="Permanent link"></a></h2>
<p>消费者从broker获取消息并将其提供给应用程序。对于应用程序而言,提供了两种consumer:</p>
<ul>
<li>
<p>pullConsumer
    pull consumer 从broker主动拉取消息，一旦拉去了批量的消息，应用程序发起消费程序。</p>
</li>
<li>
<p>pushConsumer
    push consumer，反过来讲，封装消息提取，消费进度并维护其它内部工作，给出一个 callback 接口，让用户实现，当消息到达时执行。</p>
</li>
</ul>
<h2 id="_3">简单的例子<a class="headerlink" href="#_3" title="Permanent link"></a></h2>
<h3 id="pullconsumer">pullConsumer<a class="headerlink" href="#pullconsumer" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span class="kn">package</span> <span class="nn">top.ljming.mqconsumer.clients</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.client.consumer.DefaultMQPullConsumer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.client.consumer.PullResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.client.exception.MQBrokerException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.client.exception.MQClientException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.common.message.MessageQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.rocketmq.remoting.exception.RemotingException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">top.ljming.mqconsumer.topic.SimpleTopic</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.OffsetDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 描述类的功能.</span>
<span class="cm"> *</span>
<span class="cm"> * @author ljming</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimplePullConsumer</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${mq.address}&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nameSrv</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">MessageQueue</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">OFFSET_TABLE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span> <span class="c1">// 自己维护offset</span>

    <span class="kd">private</span> <span class="n">DefaultMQPullConsumer</span> <span class="n">simplePullConsumer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;init simpleConsumer&quot;</span><span class="o">);</span>
        <span class="n">startConsumer</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startConsumer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">simplePullConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultMQPullConsumer</span><span class="o">(</span><span class="s">&quot;simpleConsumer&quot;</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotEmpty</span><span class="o">(</span><span class="n">nameSrv</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">simplePullConsumer</span><span class="o">.</span><span class="na">setNamesrvAddr</span><span class="o">(</span><span class="n">nameSrv</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">MessageQueue</span><span class="o">&gt;</span> <span class="n">messageQueueSet</span> <span class="o">=</span> <span class="n">simplePullConsumer</span><span class="o">.</span><span class="na">fetchSubscribeMessageQueues</span><span class="o">(</span><span class="n">SimpleTopic</span><span class="o">.</span><span class="na">SIMPLEPULLTOPIC</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">messageQueueSet</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">mq</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">simplePullConsumer</span><span class="o">.</span><span class="na">fetchConsumeOffset</span><span class="o">(</span><span class="n">mq</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Consumer from the queue : &quot;</span> <span class="o">+</span> <span class="n">mq</span><span class="o">);</span>
                    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">PullResult</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">simplePullConsumer</span><span class="o">.</span><span class="na">pullBlockIfNotFound</span><span class="o">(</span><span class="n">mq</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">getMessageQueueOffset</span><span class="o">(</span><span class="n">mq</span><span class="o">),</span> <span class="mi">32</span><span class="o">);</span>
                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;pr: &quot;</span> <span class="o">+</span> <span class="n">pr</span><span class="o">);</span>
                        <span class="n">putMessageQueueOffset</span><span class="o">(</span><span class="n">mq</span><span class="o">,</span> <span class="n">pr</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>
                        <span class="k">switch</span> <span class="o">(</span><span class="n">pr</span><span class="o">.</span><span class="na">getPullStatus</span><span class="o">())</span> <span class="o">{</span>
                            <span class="k">case</span> <span class="n">FOUND</span><span class="o">:</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="n">NO_NEW_MSG</span><span class="o">:</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="n">NO_MATCHED_MSG</span><span class="o">:</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">case</span> <span class="n">OFFSET_ILLEGAL</span><span class="o">:</span>
                                <span class="k">break</span><span class="o">;</span>
                            <span class="k">default</span><span class="o">:</span>
                                <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">simplePullConsumer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;consumer started&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;consumer start error: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">long</span> <span class="nf">getMessageQueueOffset</span><span class="o">(</span><span class="n">MessageQueue</span> <span class="n">mq</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">OFFSET_TABLE</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">mq</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">offset</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">putMessageQueueOffset</span><span class="o">(</span><span class="n">MessageQueue</span> <span class="n">mq</span><span class="o">,</span> <span class="kt">long</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OFFSET_TABLE</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">mq</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3 id="pushconsumer">pushConsumer<a class="headerlink" href="#pushconsumer" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">MQClientException</span> <span class="o">{</span>

        <span class="c1">// Instantiate with specified consumer group name.</span>
        <span class="n">DefaultMQPushConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultMQPushConsumer</span><span class="o">(</span><span class="s">&quot;simpleConsumer&quot;</span><span class="o">);</span>

        <span class="c1">// Specify name server addresses.</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">setNamesrvAddr</span><span class="o">(</span><span class="s">&quot;localhost:9876&quot;</span><span class="o">);</span>

        <span class="c1">// Subscribe one more more topics to consume.</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="s">&quot;TopicTest&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">);</span>
        <span class="c1">// Register callback to execute on arrival of messages fetched from brokers.</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">registerMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="n">MessageListenerConcurrently</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">ConsumeConcurrentlyStatus</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">MessageExt</span><span class="o">&gt;</span> <span class="n">msgs</span><span class="o">,</span>
                <span class="n">ConsumeConcurrentlyContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&quot;%s Receive New Messages: %s %n&quot;</span><span class="o">,</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">msgs</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">ConsumeConcurrentlyStatus</span><span class="o">.</span><span class="na">CONSUME_SUCCESS</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//Launch the consumer instance.</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&quot;Consumer Started.%n&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2 id="consumser">consumser 启动<a class="headerlink" href="#consumser" title="Permanent link"></a></h2>
<p>consumer的启动也是rocketmq的一个客户端的启动，比较注意的几点是：
- offset的加载: cluster的消费模式，从远程broker加载；broadCast模式，从本地文件加载。
- consumerMessageService的类型，根据用户注册的监听器类型有关，分为ConsumeMessageOrderlyService 和 ConsumeMessageConcurrentlyService
- pullMessageService.start(): 拉取消息的服务
- rebalanceService.start(): 负载均衡服务</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">MQClientException</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">serviceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">CREATE_JUST</span><span class="o">:</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;the consumer [{}] start beginning. messageModel={}, isUnitMode={}&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getMessageModel</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">isUnitMode</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">serviceState</span> <span class="o">=</span> <span class="n">ServiceState</span><span class="o">.</span><span class="na">START_FAILED</span><span class="o">;</span>

            <span class="k">this</span><span class="o">.</span><span class="na">checkConfig</span><span class="o">();</span>

            <span class="k">this</span><span class="o">.</span><span class="na">copySubscription</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getMessageModel</span><span class="o">()</span> <span class="o">==</span> <span class="n">MessageModel</span><span class="o">.</span><span class="na">CLUSTERING</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">changeInstanceNameToPID</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// 创建一个consumer实例</span>
            <span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span> <span class="o">=</span> <span class="n">MQClientManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getAndCreateMQClientInstance</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">rpcHook</span><span class="o">);</span>

            <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">setConsumerGroup</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">setMessageModel</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getMessageModel</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">setAllocateMessageQueueStrategy</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getAllocateMessageQueueStrategy</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">setmQClientFactory</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">);</span>

            <span class="k">this</span><span class="o">.</span><span class="na">pullAPIWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PullAPIWrapper</span><span class="o">(</span>
                <span class="n">mQClientFactory</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span> <span class="n">isUnitMode</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">pullAPIWrapper</span><span class="o">.</span><span class="na">registerFilterMessageHook</span><span class="o">(</span><span class="n">filterMessageHookList</span><span class="o">);</span>
            <span class="c1">// 加载offset</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getOffsetStore</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getOffsetStore</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">switch</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getMessageModel</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="n">BROADCASTING</span><span class="o">:</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalFileOffsetStore</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="n">CLUSTERING</span><span class="o">:</span>
                        <span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RemoteBrokerOffsetStore</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">setOffsetStore</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
            <span class="c1">// 消费消息的服务启动</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getMessageListenerInner</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">MessageListenerOrderly</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeOrderly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeMessageService</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="n">ConsumeMessageOrderlyService</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">MessageListenerOrderly</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">getMessageListenerInner</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getMessageListenerInner</span><span class="o">()</span> <span class="k">instanceof</span> <span class="n">MessageListenerConcurrently</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeOrderly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeMessageService</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="o">(</span><span class="n">MessageListenerConcurrently</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">getMessageListenerInner</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="k">this</span><span class="o">.</span><span class="na">consumeMessageService</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

            <span class="kt">boolean</span> <span class="n">registerOK</span> <span class="o">=</span> <span class="n">mQClientFactory</span><span class="o">.</span><span class="na">registerConsumer</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">registerOK</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">serviceState</span> <span class="o">=</span> <span class="n">ServiceState</span><span class="o">.</span><span class="na">CREATE_JUST</span><span class="o">;</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeMessageService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">MQClientException</span><span class="o">(</span><span class="s">&quot;The consumer group[&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">&quot;] has been created before, specify another name please.&quot;</span> <span class="o">+</span> <span class="n">FAQUrl</span><span class="o">.</span><span class="na">suggestTodo</span><span class="o">(</span><span class="n">FAQUrl</span><span class="o">.</span><span class="na">GROUP_NAME_DUPLICATE_URL</span><span class="o">),</span>
                    <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">mQClientFactory</span><span class="o">.</span><span class="na">start</span><span class="o">();</span> <span class="c1">// consumer 实例启动</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;the consumer [{}] start OK.&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">serviceState</span> <span class="o">=</span> <span class="n">ServiceState</span><span class="o">.</span><span class="na">RUNNING</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">RUNNING</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">START_FAILED</span><span class="o">:</span>
        <span class="k">case</span> <span class="n">SHUTDOWN_ALREADY</span><span class="o">:</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">MQClientException</span><span class="o">(</span><span class="s">&quot;The PushConsumer service state not OK, maybe started once, &quot;</span>
                <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">serviceState</span>
                <span class="o">+</span> <span class="n">FAQUrl</span><span class="o">.</span><span class="na">suggestTodo</span><span class="o">(</span><span class="n">FAQUrl</span><span class="o">.</span><span class="na">CLIENT_SERVICE_NOT_OK</span><span class="o">),</span>
                <span class="kc">null</span><span class="o">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">updateTopicSubscribeInfoWhenSubscriptionChanged</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">.</span><span class="na">checkClientInBroker</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">.</span><span class="na">sendHeartbeatToAllBrokerWithLock</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mQClientFactory</span><span class="o">.</span><span class="na">rebalanceImmediately</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<h2 id="consumer">consumer消息消费<a class="headerlink" href="#consumer" title="Permanent link"></a></h2>
<p>这里基于Push模式分析。在consumer启动的时候，说到consumer实例启动时，会启动一个pullMessageService的服务，这个服务主要就是用来拉取消息的。虽然是push模式，但是也是consumer主动发起拉取消息给broker，broker接收到拉取消息的请求，基于长轮询的策略，给予响应。</p>
<h3 id="pullmessageservice">PullMessageService: 消息拉取服务<a class="headerlink" href="#pullmessageservice" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServiceName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; service started&quot;</span><span class="o">);</span>

    <span class="k">while</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">isStopped</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">PullRequest</span> <span class="n">pullRequest</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">pullRequestQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">pullMessage</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Pull Message Service Run Method exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServiceName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; service end&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<p>PullMessageService一旦启动就会从pullRequestQueue中获取PullRequest。pullRequestQueue是一个阻塞队列，只有当pullRequestQueue.take()获取到数据时才会返回，否者当前线程就会一直阻塞，直到拿到数据。</p>
<p>问题：当PullMessageService启动时，pullRequestQueue是空的，也就是说this.pullRequestQueue.take()是拿不到数据，那当前线程岂不是一直都被阻塞了。也没有下面的拉取过程之说了？</p>
<p>继续来看pullMessage的实现。拉取消息的具体实现在DefaultMQPushConsumerImpl类中。</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">pullMessage</span><span class="o">(</span><span class="kd">final</span> <span class="n">PullRequest</span> <span class="n">pullRequest</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ProcessQueue</span> <span class="n">processQueue</span> <span class="o">=</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">getProcessQueue</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">processQueue</span><span class="o">.</span><span class="na">isDropped</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;the pull request[{}] is dropped.&quot;</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">pullRequest</span><span class="o">.</span><span class="na">getProcessQueue</span><span class="o">().</span><span class="na">setLastPullTimestamp</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">makeSureStateOK</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MQClientException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;pullMessage exception, consumer state not ok&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">isPause</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;consumer was paused, execute pull request later. instanceName={}, group={}&quot;</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getInstanceName</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_SUSPEND</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">cachedMessageCount</span> <span class="o">=</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgCount</span><span class="o">().</span><span class="na">get</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">cachedMessageSizeInMiB</span> <span class="o">=</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgSize</span><span class="o">().</span><span class="na">get</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">cachedMessageCount</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullThresholdForQueue</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">queueFlowControlTimes</span><span class="o">++</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
                <span class="s">&quot;the cached message count exceeds the threshold {}, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}&quot;</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullThresholdForQueue</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">firstKey</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">lastKey</span><span class="o">(),</span> <span class="n">cachedMessageCount</span><span class="o">,</span> <span class="n">cachedMessageSizeInMiB</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">,</span> <span class="n">queueFlowControlTimes</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">cachedMessageSizeInMiB</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullThresholdSizeForQueue</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">queueFlowControlTimes</span><span class="o">++</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
                <span class="s">&quot;the cached message size exceeds the threshold {} MiB, so do flow control, minOffset={}, maxOffset={}, count={}, size={} MiB, pullRequest={}, flowControlTimes={}&quot;</span><span class="o">,</span>
                <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullThresholdSizeForQueue</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">firstKey</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">lastKey</span><span class="o">(),</span> <span class="n">cachedMessageCount</span><span class="o">,</span> <span class="n">cachedMessageSizeInMiB</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">,</span> <span class="n">queueFlowControlTimes</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">consumeOrderly</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">processQueue</span><span class="o">.</span><span class="na">getMaxSpan</span><span class="o">()</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumeConcurrentlyMaxSpan</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">queueMaxSpanFlowControlTimes</span><span class="o">++</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
                    <span class="s">&quot;the queue&#39;s messages, span too long, so do flow control, minOffset={}, maxOffset={}, maxSpan={}, pullRequest={}, flowControlTimes={}&quot;</span><span class="o">,</span>
                    <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">firstKey</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMsgTreeMap</span><span class="o">().</span><span class="na">lastKey</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">getMaxSpan</span><span class="o">(),</span>
                    <span class="n">pullRequest</span><span class="o">,</span> <span class="n">queueMaxSpanFlowControlTimes</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">processQueue</span><span class="o">.</span><span class="na">isLocked</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">isLockedFirst</span><span class="o">())</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">computePullFromWhere</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">());</span>
                <span class="kt">boolean</span> <span class="n">brokerBusy</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}&quot;</span><span class="o">,</span>
                    <span class="n">pullRequest</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">brokerBusy</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">brokerBusy</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}&quot;</span><span class="o">,</span>
                        <span class="n">pullRequest</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
                <span class="o">}</span>

                <span class="n">pullRequest</span><span class="o">.</span><span class="na">setLockedFirst</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">offset</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;pull message later because not locked in broker, {}&quot;</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">SubscriptionData</span> <span class="n">subscriptionData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">getSubscriptionInner</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">subscriptionData</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;find the consumer&#39;s subscription failed, {}&quot;</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="kt">long</span> <span class="n">beginTimestamp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

    <span class="n">PullCallback</span> <span class="n">pullCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PullCallback</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">PullResult</span> <span class="n">pullResult</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pullResult</span> <span class="o">=</span> <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">pullAPIWrapper</span><span class="o">.</span><span class="na">processPullResult</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">,</span>
                    <span class="n">subscriptionData</span><span class="o">);</span>

                <span class="k">switch</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getPullStatus</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="n">FOUND</span><span class="o">:</span>
                        <span class="kt">long</span> <span class="n">prevRequestOffset</span> <span class="o">=</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">();</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>
                        <span class="kt">long</span> <span class="n">pullRT</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">beginTimestamp</span><span class="o">;</span>
                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getConsumerStatsManager</span><span class="o">().</span><span class="na">incPullRT</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span>
                            <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">(),</span> <span class="n">pullRT</span><span class="o">);</span>

                        <span class="kt">long</span> <span class="n">firstMsgOffset</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">firstMsgOffset</span> <span class="o">=</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getQueueOffset</span><span class="o">();</span>

                            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getConsumerStatsManager</span><span class="o">().</span><span class="na">incPullTPS</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span>
                                <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>

                            <span class="kt">boolean</span> <span class="n">dispatchToConsume</span> <span class="o">=</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">putMessage</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">());</span>
                            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumeMessageService</span><span class="o">.</span><span class="na">submitConsumeRequest</span><span class="o">(</span>
                                <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">(),</span>
                                <span class="n">processQueue</span><span class="o">,</span>
                                <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span>
                                <span class="n">dispatchToConsume</span><span class="o">);</span>

                            <span class="k">if</span> <span class="o">(</span><span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullInterval</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span>
                                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullInterval</span><span class="o">());</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">prevRequestOffset</span>
                            <span class="o">||</span> <span class="n">firstMsgOffset</span> <span class="o">&lt;</span> <span class="n">prevRequestOffset</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
                                <span class="s">&quot;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&quot;</span><span class="o">,</span>
                                <span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">(),</span>
                                <span class="n">firstMsgOffset</span><span class="o">,</span>
                                <span class="n">prevRequestOffset</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="n">NO_NEW_MSG</span><span class="o">:</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">correctTagsOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>

                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="n">NO_MATCHED_MSG</span><span class="o">:</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">correctTagsOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>

                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="n">OFFSET_ILLEGAL</span><span class="o">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;the pull request offset illegal, {} {}&quot;</span><span class="o">,</span>
                            <span class="n">pullRequest</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">getProcessQueue</span><span class="o">().</span><span class="na">setDropped</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executeTaskLater</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>

                            <span class="nd">@Override</span>
                            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span>
                                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">updateOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span>
                                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>

                                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">());</span>

                                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">removeProcessQueue</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">());</span>

                                    <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;fix the pull request offset, {}&quot;</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">);</span>
                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;executeTaskLater Exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                                <span class="o">}</span>
                            <span class="o">}</span>
                        <span class="o">},</span> <span class="mi">10000</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">MixAll</span><span class="o">.</span><span class="na">RETRY_GROUP_TOPIC_PREFIX</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;execute the pull request exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>

    <span class="kt">boolean</span> <span class="n">commitOffsetEnable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">commitOffsetValue</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">MessageModel</span><span class="o">.</span><span class="na">CLUSTERING</span> <span class="o">==</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getMessageModel</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">commitOffsetValue</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">readOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span> <span class="n">ReadOffsetType</span><span class="o">.</span><span class="na">READ_FROM_MEMORY</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">commitOffsetValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">commitOffsetEnable</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">subExpression</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">classFilter</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">SubscriptionData</span> <span class="n">sd</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">getSubscriptionInner</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sd</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">isPostSubscriptionWhenPull</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sd</span><span class="o">.</span><span class="na">isClassFilterMode</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">subExpression</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">getSubString</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">classFilter</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">isClassFilterMode</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="n">sysFlag</span> <span class="o">=</span> <span class="n">PullSysFlag</span><span class="o">.</span><span class="na">buildSysFlag</span><span class="o">(</span>
        <span class="n">commitOffsetEnable</span><span class="o">,</span> <span class="c1">// commitOffset</span>
        <span class="kc">true</span><span class="o">,</span> <span class="c1">// suspend</span>
        <span class="n">subExpression</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span> <span class="c1">// subscription</span>
        <span class="n">classFilter</span> <span class="c1">// class filter</span>
    <span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pullAPIWrapper</span><span class="o">.</span><span class="na">pullKernelImpl</span><span class="o">(</span>
            <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span>
            <span class="n">subExpression</span><span class="o">,</span>
            <span class="n">subscriptionData</span><span class="o">.</span><span class="na">getExpressionType</span><span class="o">(),</span>
            <span class="n">subscriptionData</span><span class="o">.</span><span class="na">getSubVersion</span><span class="o">(),</span>
            <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">(),</span>
            <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullBatchSize</span><span class="o">(),</span>
            <span class="n">sysFlag</span><span class="o">,</span>
            <span class="n">commitOffsetValue</span><span class="o">,</span>
            <span class="n">BROKER_SUSPEND_MAX_TIME_MILLIS</span><span class="o">,</span>
            <span class="n">CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND</span><span class="o">,</span>
            <span class="n">CommunicationMode</span><span class="o">.</span><span class="na">ASYNC</span><span class="o">,</span>
            <span class="n">pullCallback</span>
        <span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;pullKernelImpl exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>在提交pullRequest时，有一个流量控制，PullRequst对象有个ProcessQueue对象，ProcessQueue对象保存了对应MessageQueue消息处理状态的快照。ProcessQueue对象里主要的内容是一个 TreeMap 和一个读写锁。 TreeMap 里以 MessageQueue 的 Offset 作为 Key，以消息内容为 Value，保存了 所有从 MessageQueue 获取到，但是还未被处理的消息; 读写锁控制着多个线程对 TreeMap 对象的并发访问 。</p>
<p>consumer客户端在提交拉取请求前都会做以下几个判断:</p>
<p><img alt="消息流量控制" src="/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/flow_controller.jpg"></p>
<p>当上述判断被流控了，当前PullRequest对象会被扔到PullMessageService服务的一个定时任务里，任务延迟时间根据不同的流控时间而不同。</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">executePullRequestLater</span><span class="o">(</span><span class="kd">final</span> <span class="n">PullRequest</span> <span class="n">pullRequest</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeDelay</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">isStopped</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">scheduledExecutorService</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">PullMessageService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="n">timeDelay</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;PullMessageServiceScheduledThread has shutdown&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>PullCallback 对象在PullRequest执行完成，返回时进行回调。拉取的核心实现在pullAPIWrapper中实现，调用了 pullAPIWrapper.pullKernelImpl方法。在这个方法中，做了以下操作：</p>
<ul>
<li>获取要拉取消息的broker地址</li>
<li>构建PullMessageRequestHeader对象</li>
</ul>
<p>然后通过调用MQClientAPIImpl对象的PullMessage方法向broker发起拉取消息请求。MQClientAPIImpl封装了客户端和服务器端通信的api。</p>
<p>在MQClientAPIImpl.pullMessage中，根据Communication不同，进行不同的实现。</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">PullResult</span> <span class="nf">pullMessage</span><span class="o">(</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">addr</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">PullMessageRequestHeader</span> <span class="n">requestHeader</span><span class="o">,</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">timeoutMillis</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">CommunicationMode</span> <span class="n">communicationMode</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">PullCallback</span> <span class="n">pullCallback</span>
<span class="o">)</span> <span class="kd">throws</span> <span class="n">RemotingException</span><span class="o">,</span> <span class="n">MQBrokerException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
    <span class="n">RemotingCommand</span> <span class="n">request</span> <span class="o">=</span> <span class="n">RemotingCommand</span><span class="o">.</span><span class="na">createRequestCommand</span><span class="o">(</span><span class="n">RequestCode</span><span class="o">.</span><span class="na">PULL_MESSAGE</span><span class="o">,</span> <span class="n">requestHeader</span><span class="o">);</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">communicationMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">ONEWAY</span><span class="o">:</span>
            <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">ASYNC</span><span class="o">:</span>
            <span class="k">this</span><span class="o">.</span><span class="na">pullMessageAsync</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">timeoutMillis</span><span class="o">,</span> <span class="n">pullCallback</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">SYNC</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">pullMessageSync</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">timeoutMillis</span><span class="o">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">assert</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>在拉取消息的实现中，push模式的consumer，采用的ASYNC的通信方式，pull模式的consumer，采用的SYNC的通信方式。由于consumer是基于push模式分析的，这里看ASYNC通信方式的实现。ASYNC的拉取方式，会传入一个PullCallback类，有两个抽象方法，onSuccess和onException，针对拉取消息放回结果进行不同的调用不同的实现方法。</p>
<div class="codehilite"><pre><span class="n">PullCallback</span> <span class="n">pullCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PullCallback</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">(</span><span class="n">PullResult</span> <span class="n">pullResult</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pullResult</span> <span class="o">=</span> <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">pullAPIWrapper</span><span class="o">.</span><span class="na">processPullResult</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">,</span>
                <span class="n">subscriptionData</span><span class="o">);</span>

            <span class="k">switch</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getPullStatus</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">case</span> <span class="n">FOUND</span><span class="o">:</span>
                    <span class="kt">long</span> <span class="n">prevRequestOffset</span> <span class="o">=</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">();</span>
                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>
                    <span class="kt">long</span> <span class="n">pullRT</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">beginTimestamp</span><span class="o">;</span>
                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getConsumerStatsManager</span><span class="o">().</span><span class="na">incPullRT</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">(),</span> <span class="n">pullRT</span><span class="o">);</span>

                    <span class="kt">long</span> <span class="n">firstMsgOffset</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">firstMsgOffset</span> <span class="o">=</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getQueueOffset</span><span class="o">();</span>

                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getConsumerStatsManager</span><span class="o">().</span><span class="na">incPullTPS</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">(),</span>
                            <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">().</span><span class="na">size</span><span class="o">());</span>

                        <span class="kt">boolean</span> <span class="n">dispatchToConsume</span> <span class="o">=</span> <span class="n">processQueue</span><span class="o">.</span><span class="na">putMessage</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">());</span>
                        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumeMessageService</span><span class="o">.</span><span class="na">submitConsumeRequest</span><span class="o">(</span>
                            <span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">(),</span>
                            <span class="n">processQueue</span><span class="o">,</span>
                            <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span>
                            <span class="n">dispatchToConsume</span><span class="o">);</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullInterval</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span>
                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getPullInterval</span><span class="o">());</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>

                    <span class="k">if</span> <span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">prevRequestOffset</span>
                        <span class="o">||</span> <span class="n">firstMsgOffset</span> <span class="o">&lt;</span> <span class="n">prevRequestOffset</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
                            <span class="s">&quot;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&quot;</span><span class="o">,</span>
                            <span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">(),</span>
                            <span class="n">firstMsgOffset</span><span class="o">,</span>
                            <span class="n">prevRequestOffset</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">NO_NEW_MSG</span><span class="o">:</span>
                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">correctTagsOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>

                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">NO_MATCHED_MSG</span><span class="o">:</span>
                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">correctTagsOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>

                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestImmediately</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">OFFSET_ILLEGAL</span><span class="o">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;the pull request offset illegal, {} {}&quot;</span><span class="o">,</span>
                        <span class="n">pullRequest</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">pullResult</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">setNextOffset</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getNextBeginOffset</span><span class="o">());</span>

                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">getProcessQueue</span><span class="o">().</span><span class="na">setDropped</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                    <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executeTaskLater</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                            <span class="k">try</span> <span class="o">{</span>
                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">updateOffset</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span>
                                    <span class="n">pullRequest</span><span class="o">.</span><span class="na">getNextOffset</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>

                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">offsetStore</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">());</span>

                                <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">rebalanceImpl</span><span class="o">.</span><span class="na">removeProcessQueue</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">());</span>

                                <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;fix the pull request offset, {}&quot;</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">);</span>
                            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;executeTaskLater Exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span>
                    <span class="o">},</span> <span class="mi">10000</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">().</span><span class="na">getTopic</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">MixAll</span><span class="o">.</span><span class="na">RETRY_GROUP_TOPIC_PREFIX</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;execute the pull request exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">executePullRequestLater</span><span class="o">(</span><span class="n">pullRequest</span><span class="o">,</span> <span class="n">PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>拉取成功，PullResult的PullStatus属性有以下几种值：</p>
<ul>
<li>FOUND: 表示成功拉取到消息</li>
<li>NO_NEW_MSG: 表示当前messageQueue中没有新消息</li>
<li>NO_MATCHED_MSG: 表示当前MessageQueue中没有满足条件的消息</li>
<li>OFFSET_ILLEGAL: 表示传入的offset值非法</li>
</ul>
<p><strong>FOUND</strong></p>
<ul>
<li>pullRequest设置offset为下一个offset，构建下次拉取消息的请求对象</li>
<li>consumerStatsManager时间窗口内的拉取次数+1</li>
<li>如果拉取到的消息为空，立即执行下一次拉取请求</li>
<li>consumerStatsManager TPS统计</li>
<li>将拉取到的消息添加到ProcessQueue中</li>
<li>提交一个消息消费任务</li>
<li>判断拉取时间间隔，进行下一次的消息拉取</li>
</ul>
<p><strong>NO_NEW_MSG || NO_MATCHED_MSG</strong></p>
<p>取下一个offset的数据，立即执行pullRequest</p>
<p><strong>OFFSET_ILLEGAL</strong></p>
<p>丢弃当前processQueue，启动一个延时任务：跟新MessageQueue的offset，持久化offset，在负载均衡中丢弃当前processQueue。</p>
<h3 id="consumemessageservice">consumeMessageService 服务消费消息<a class="headerlink" href="#consumemessageservice" title="Permanent link"></a></h3>
<p>前面讲到当PullStatus为FOUND，且拉取到的消息不为空，则提交了一个消息消费的任务。</p>
<div class="codehilite"><pre><span class="n">DefaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumeMessageService</span><span class="o">.</span><span class="na">submitConsumeRequest</span><span class="o">(</span><span class="n">pullResult</span><span class="o">.</span><span class="na">getMsgFoundList</span><span class="o">(),</span> <span class="n">processQueue</span><span class="o">,</span> <span class="n">pullRequest</span><span class="o">.</span><span class="na">getMessageQueue</span><span class="o">(),</span> <span class="n">dispatchToConsume</span><span class="o">);</span>
</pre></div>

<p>这里的实现就得看ConsumeMessageService.submitConsumerRequest方法</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">submitConsumeRequest</span><span class="o">(</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MessageExt</span><span class="o">&gt;</span> <span class="n">msgs</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">ProcessQueue</span> <span class="n">processQueue</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">MessageQueue</span> <span class="n">messageQueue</span><span class="o">,</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">dispatchToConsume</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">consumeBatchSize</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumeMessageBatchMaxSize</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msgs</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">consumeBatchSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ConsumeRequest</span> <span class="n">consumeRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumeRequest</span><span class="o">(</span><span class="n">msgs</span><span class="o">,</span> <span class="n">processQueue</span><span class="o">,</span> <span class="n">messageQueue</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">consumeExecutor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">consumeRequest</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RejectedExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">submitConsumeRequestLater</span><span class="o">(</span><span class="n">consumeRequest</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">msgs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">MessageExt</span><span class="o">&gt;</span> <span class="n">msgThis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">MessageExt</span><span class="o">&gt;(</span><span class="n">consumeBatchSize</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">consumeBatchSize</span><span class="o">;</span> <span class="n">i</span><span class="o">++,</span> <span class="n">total</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">msgs</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">msgThis</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msgs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">total</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="n">ConsumeRequest</span> <span class="n">consumeRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumeRequest</span><span class="o">(</span><span class="n">msgThis</span><span class="o">,</span> <span class="n">processQueue</span><span class="o">,</span> <span class="n">messageQueue</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">consumeExecutor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">consumeRequest</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RejectedExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">msgs</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">total</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">msgThis</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msgs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">total</span><span class="o">));</span>
                <span class="o">}</span>

                <span class="k">this</span><span class="o">.</span><span class="na">submitConsumeRequestLater</span><span class="o">(</span><span class="n">consumeRequest</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>这里的实现，在线程池中提交了一个ConsumerRequest的任务，该ConsumerRequest对象实现了Runnable接口，那么就看下ConsumerRequest的run方法：</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">processQueue</span><span class="o">.</span><span class="na">isDropped</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;the message queue not be able to consume, because it&#39;s dropped. group={} {}&quot;</span><span class="o">,</span> <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumerGroup</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">messageQueue</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">MessageListenerConcurrently</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">messageListener</span><span class="o">;</span>
    <span class="n">ConsumeConcurrentlyContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumeConcurrentlyContext</span><span class="o">(</span><span class="n">messageQueue</span><span class="o">);</span>
    <span class="n">ConsumeConcurrentlyStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="n">ConsumeMessageContext</span> <span class="n">consumeMessageContext</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">hasHook</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">consumeMessageContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumeMessageContext</span><span class="o">();</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setConsumerGroup</span><span class="o">(</span><span class="n">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumerGroup</span><span class="o">());</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setProps</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;());</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setMq</span><span class="o">(</span><span class="n">messageQueue</span><span class="o">);</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setMsgList</span><span class="o">(</span><span class="n">msgs</span><span class="o">);</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">executeHookBefore</span><span class="o">(</span><span class="n">consumeMessageContext</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">long</span> <span class="n">beginTimestamp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">hasException</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">ConsumeReturnType</span> <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">resetRetryTopic</span><span class="o">(</span><span class="n">msgs</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msgs</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msgs</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">MessageExt</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">msgs</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">MessageAccessor</span><span class="o">.</span><span class="na">setConsumeStartTimeStamp</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()));</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="na">consumeMessage</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">msgs</span><span class="o">),</span> <span class="n">context</span><span class="o">);</span> <span class="c1">// 用户自定义的消息监听器，进行消息消费，需用用户自己实现</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;consumeMessage exception: {} Group: {} Msgs: {} MQ: {}&quot;</span><span class="o">,</span>
            <span class="n">RemotingHelper</span><span class="o">.</span><span class="na">exceptionSimpleDesc</span><span class="o">(</span><span class="n">e</span><span class="o">),</span>
            <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumerGroup</span><span class="o">,</span>
            <span class="n">msgs</span><span class="o">,</span>
            <span class="n">messageQueue</span><span class="o">);</span>
        <span class="n">hasException</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">long</span> <span class="n">consumeRT</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">beginTimestamp</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hasException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">EXCEPTION</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">RETURNNULL</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">consumeRT</span> <span class="o">&gt;=</span> <span class="n">defaultMQPushConsumer</span><span class="o">.</span><span class="na">getConsumeTimeout</span><span class="o">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">TIME_OUT</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ConsumeConcurrentlyStatus</span><span class="o">.</span><span class="na">RECONSUME_LATER</span> <span class="o">==</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">FAILED</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ConsumeConcurrentlyStatus</span><span class="o">.</span><span class="na">CONSUME_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">returnType</span> <span class="o">=</span> <span class="n">ConsumeReturnType</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">hasHook</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">getProps</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">MixAll</span><span class="o">.</span><span class="na">CONSUME_CONTEXT_TYPE</span><span class="o">,</span> <span class="n">returnType</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;consumeMessage return null, Group: {} Msgs: {} MQ: {}&quot;</span><span class="o">,</span>
            <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumerGroup</span><span class="o">,</span>
            <span class="n">msgs</span><span class="o">,</span>
            <span class="n">messageQueue</span><span class="o">);</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">ConsumeConcurrentlyStatus</span><span class="o">.</span><span class="na">RECONSUME_LATER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">hasHook</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">consumeMessageContext</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="n">ConsumeConcurrentlyStatus</span><span class="o">.</span><span class="na">CONSUME_SUCCESS</span> <span class="o">==</span> <span class="n">status</span><span class="o">);</span>
        <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">defaultMQPushConsumerImpl</span><span class="o">.</span><span class="na">executeHookAfter</span><span class="o">(</span><span class="n">consumeMessageContext</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getConsumerStatsManager</span><span class="o">()</span>
        <span class="o">.</span><span class="na">incConsumeRT</span><span class="o">(</span><span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">consumerGroup</span><span class="o">,</span> <span class="n">messageQueue</span><span class="o">.</span><span class="na">getTopic</span><span class="o">(),</span> <span class="n">consumeRT</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">processQueue</span><span class="o">.</span><span class="na">isDropped</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">ConsumeMessageConcurrentlyService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">processConsumeResult</span><span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;processQueue is dropped without process consume result. messageQueue={}, msgs={}&quot;</span><span class="o">,</span> <span class="n">messageQueue</span><span class="o">,</span> <span class="n">msgs</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>用户自定对消息消费完会返回一个状态：
- CONSUME_SUCCESS: 消费成功
- RECONSUME_LATER: 稍后重新消费</p>
<h3 id="consumemessageservice_1">consumeMessageService 服务消息消费重试机制<a class="headerlink" href="#consumemessageservice_1" title="Permanent link"></a></h3>
<p>上面说到，consumer端消费消息，会返回一个状态&ndash;ConsumeConcurrentlyStatus（并发模式下）。当返回的状态是RECONSUME_LATER时，则表示该消息需要稍后重新消费。消息消费完之后，会对返回的status进行处理，处理的逻辑在ConsumeMessageConcurrentlyService.processConsumerResult:</p>
<p><img alt="处理消费结果" src="/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/process_consumer_result.jpg"></p>
<p>从图中可以看出，status=CONSUME_SUCCESS时，会计算出成功的消息条数和失败的消息条数，然后通过ConsumerStatsManager统计消息消费和失败的TPS；</p>
<p>当status=RECONSUME_LATER; ackIndex=-1; 这时就需要将失败的消息重新消费。</p>
<p><img alt="重新消费" src="/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/consumer_send_back.jpg"></p>
<p>根据不同的消费状态，设置的不同ackIndex的值。当从代码中可知，当status=CONSUME_SUCCESS时，是不会给broker发送back消息的。当消息需要被重新消费时，才会想broker发送back消息。如果发送给broker的back消息的msg失败，则会将这些消息扔到一个集合，然后重新发送一个ConsumeRequest。</p>
<p>给broker发送消息重发请求是，发送的REQUEST_CODE=CONSUMER_SEND_MSG_BACK=36。broker处理这个请求的处理器是SendMessageProcessor。在broker源码分析中，broker初始化是，会注册一系列的处理器。对于RequestCode=CONSUMER_SEND_MSG_BACK的请求，对应的处理器是SendMessageProcessor。
<div class="codehilite"><pre><span class="k">this</span><span class="o">.</span><span class="na">remotingServer</span><span class="o">.</span><span class="na">registerProcessor</span><span class="o">(</span><span class="n">RequestCode</span><span class="o">.</span><span class="na">CONSUMER_SEND_MSG_BACK</span><span class="o">,</span> <span class="n">sendProcessor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">sendMessageExecutor</span><span class="o">);</span>
</pre></div></p>
<p>接下来， 就看看broker接收到这个请求，如何处理的。这个实现在SendMessageProcessor.consumerSendMsgBack()方法中</p>
<p><div class="codehilite"><pre><span class="kd">private</span> <span class="n">RemotingCommand</span> <span class="nf">consumerSendMsgBack</span><span class="o">(</span><span class="kd">final</span> <span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="kd">final</span> <span class="n">RemotingCommand</span> <span class="n">request</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">RemotingCommandException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">RemotingCommand</span> <span class="n">response</span> <span class="o">=</span> <span class="n">RemotingCommand</span><span class="o">.</span><span class="na">createResponseCommand</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ConsumerSendMsgBackRequestHeader</span> <span class="n">requestHeader</span> <span class="o">=</span>
        <span class="o">(</span><span class="n">ConsumerSendMsgBackRequestHeader</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">decodeCommandCustomHeader</span><span class="o">(</span><span class="n">ConsumerSendMsgBackRequestHeader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">hasConsumeMessageHook</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">UtilAll</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getOriginMsgId</span><span class="o">()))</span> <span class="o">{</span>

        <span class="n">ConsumeMessageContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumeMessageContext</span><span class="o">();</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setConsumerGroup</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">());</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getOriginTopic</span><span class="o">());</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setCommercialRcvStats</span><span class="o">(</span><span class="n">BrokerStatsManager</span><span class="o">.</span><span class="na">StatsType</span><span class="o">.</span><span class="na">SEND_BACK</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setCommercialRcvTimes</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">setCommercialOwner</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getExtFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">BrokerStatsManager</span><span class="o">.</span><span class="na">COMMERCIAL_OWNER</span><span class="o">));</span>

        <span class="k">this</span><span class="o">.</span><span class="na">executeConsumeMessageHookAfter</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">SubscriptionGroupConfig</span> <span class="n">subscriptionGroupConfig</span> <span class="o">=</span>
        <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getSubscriptionGroupManager</span><span class="o">().</span><span class="na">findSubscriptionGroupConfig</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">subscriptionGroupConfig</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SUBSCRIPTION_GROUP_NOT_EXIST</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;subscription group not exist, &quot;</span> <span class="o">+</span> <span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
            <span class="o">+</span> <span class="n">FAQUrl</span><span class="o">.</span><span class="na">suggestTodo</span><span class="o">(</span><span class="n">FAQUrl</span><span class="o">.</span><span class="na">SUBSCRIPTION_GROUP_NOT_EXIST</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">PermName</span><span class="o">.</span><span class="na">isWriteable</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getBrokerConfig</span><span class="o">().</span><span class="na">getBrokerPermission</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">NO_PERMISSION</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;the broker[&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getBrokerConfig</span><span class="o">().</span><span class="na">getBrokerIP1</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;] sending message is forbidden&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">subscriptionGroupConfig</span><span class="o">.</span><span class="na">getRetryQueueNums</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">newTopic</span> <span class="o">=</span> <span class="n">MixAll</span><span class="o">.</span><span class="na">getRetryTopic</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">());</span>
    <span class="kt">int</span> <span class="n">queueIdInt</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">()</span> <span class="o">%</span> <span class="mi">99999999</span><span class="o">)</span> <span class="o">%</span> <span class="n">subscriptionGroupConfig</span><span class="o">.</span><span class="na">getRetryQueueNums</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">topicSysFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">isUnitMode</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">topicSysFlag</span> <span class="o">=</span> <span class="n">TopicSysFlag</span><span class="o">.</span><span class="na">buildSysFlag</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">TopicConfig</span> <span class="n">topicConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getTopicConfigManager</span><span class="o">().</span><span class="na">createTopicInSendMessageBackMethod</span><span class="o">(</span>
        <span class="n">newTopic</span><span class="o">,</span>
        <span class="n">subscriptionGroupConfig</span><span class="o">.</span><span class="na">getRetryQueueNums</span><span class="o">(),</span>
        <span class="n">PermName</span><span class="o">.</span><span class="na">PERM_WRITE</span> <span class="o">|</span> <span class="n">PermName</span><span class="o">.</span><span class="na">PERM_READ</span><span class="o">,</span> <span class="n">topicSysFlag</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">topicConfig</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SYSTEM_ERROR</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;topic[&quot;</span> <span class="o">+</span> <span class="n">newTopic</span> <span class="o">+</span> <span class="s">&quot;] not exist&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">PermName</span><span class="o">.</span><span class="na">isWriteable</span><span class="o">(</span><span class="n">topicConfig</span><span class="o">.</span><span class="na">getPerm</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">NO_PERMISSION</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;the topic[%s] sending message is forbidden&quot;</span><span class="o">,</span> <span class="n">newTopic</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">MessageExt</span> <span class="n">msgExt</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getMessageStore</span><span class="o">().</span><span class="na">lookMessageByOffset</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getOffset</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">msgExt</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SYSTEM_ERROR</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;look message by offset failed, &quot;</span> <span class="o">+</span> <span class="n">requestHeader</span><span class="o">.</span><span class="na">getOffset</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">retryTopic</span> <span class="o">=</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">MessageConst</span><span class="o">.</span><span class="na">PROPERTY_RETRY_TOPIC</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">retryTopic</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">MessageAccessor</span><span class="o">.</span><span class="na">putProperty</span><span class="o">(</span><span class="n">msgExt</span><span class="o">,</span> <span class="n">MessageConst</span><span class="o">.</span><span class="na">PROPERTY_RETRY_TOPIC</span><span class="o">,</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getTopic</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">msgExt</span><span class="o">.</span><span class="na">setWaitStoreMsgOK</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">delayLevel</span> <span class="o">=</span> <span class="n">requestHeader</span><span class="o">.</span><span class="na">getDelayLevel</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">maxReconsumeTimes</span> <span class="o">=</span> <span class="n">subscriptionGroupConfig</span><span class="o">.</span><span class="na">getRetryMaxTimes</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">MQVersion</span><span class="o">.</span><span class="na">Version</span><span class="o">.</span><span class="na">V3_4_9</span><span class="o">.</span><span class="na">ordinal</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">maxReconsumeTimes</span> <span class="o">=</span> <span class="n">requestHeader</span><span class="o">.</span><span class="na">getMaxReconsumeTimes</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getReconsumeTimes</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">maxReconsumeTimes</span>
        <span class="o">||</span> <span class="n">delayLevel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">newTopic</span> <span class="o">=</span> <span class="n">MixAll</span><span class="o">.</span><span class="na">getDLQTopic</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">());</span>
        <span class="n">queueIdInt</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">()</span> <span class="o">%</span> <span class="mi">99999999</span><span class="o">)</span> <span class="o">%</span> <span class="n">DLQ_NUMS_PER_GROUP</span><span class="o">;</span>

        <span class="n">topicConfig</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getTopicConfigManager</span><span class="o">().</span><span class="na">createTopicInSendMessageBackMethod</span><span class="o">(</span><span class="n">newTopic</span><span class="o">,</span>
            <span class="n">DLQ_NUMS_PER_GROUP</span><span class="o">,</span>
            <span class="n">PermName</span><span class="o">.</span><span class="na">PERM_WRITE</span><span class="o">,</span> <span class="mi">0</span>
        <span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">topicConfig</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SYSTEM_ERROR</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;topic[&quot;</span> <span class="o">+</span> <span class="n">newTopic</span> <span class="o">+</span> <span class="s">&quot;] not exist&quot;</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">delayLevel</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">delayLevel</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getReconsumeTimes</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">msgExt</span><span class="o">.</span><span class="na">setDelayTimeLevel</span><span class="o">(</span><span class="n">delayLevel</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">MessageExtBrokerInner</span> <span class="n">msgInner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageExtBrokerInner</span><span class="o">();</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setTopic</span><span class="o">(</span><span class="n">newTopic</span><span class="o">);</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setFlag</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getFlag</span><span class="o">());</span>
    <span class="n">MessageAccessor</span><span class="o">.</span><span class="na">setProperties</span><span class="o">(</span><span class="n">msgInner</span><span class="o">,</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getProperties</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setPropertiesString</span><span class="o">(</span><span class="n">MessageDecoder</span><span class="o">.</span><span class="na">messageProperties2String</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()));</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setTagsCode</span><span class="o">(</span><span class="n">MessageExtBrokerInner</span><span class="o">.</span><span class="na">tagsString2tagsCode</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getTags</span><span class="o">()));</span>

    <span class="n">msgInner</span><span class="o">.</span><span class="na">setQueueId</span><span class="o">(</span><span class="n">queueIdInt</span><span class="o">);</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setSysFlag</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getSysFlag</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setBornTimestamp</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getBornTimestamp</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setBornHost</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getBornHost</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setStoreHost</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getStoreHost</span><span class="o">());</span>
    <span class="n">msgInner</span><span class="o">.</span><span class="na">setReconsumeTimes</span><span class="o">(</span><span class="n">msgExt</span><span class="o">.</span><span class="na">getReconsumeTimes</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>

    <span class="n">String</span> <span class="n">originMsgId</span> <span class="o">=</span> <span class="n">MessageAccessor</span><span class="o">.</span><span class="na">getOriginMessageId</span><span class="o">(</span><span class="n">msgExt</span><span class="o">);</span>
    <span class="n">MessageAccessor</span><span class="o">.</span><span class="na">setOriginMessageId</span><span class="o">(</span><span class="n">msgInner</span><span class="o">,</span> <span class="n">UtilAll</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">originMsgId</span><span class="o">)</span> <span class="o">?</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getMsgId</span><span class="o">()</span> <span class="o">:</span> <span class="n">originMsgId</span><span class="o">);</span>

    <span class="n">PutMessageResult</span> <span class="n">putMessageResult</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getMessageStore</span><span class="o">().</span><span class="na">putMessage</span><span class="o">(</span><span class="n">msgInner</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">putMessageResult</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">putMessageResult</span><span class="o">.</span><span class="na">getPutMessageStatus</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">PUT_OK</span><span class="o">:</span>
                <span class="n">String</span> <span class="n">backTopic</span> <span class="o">=</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getTopic</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">correctTopic</span> <span class="o">=</span> <span class="n">msgExt</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">MessageConst</span><span class="o">.</span><span class="na">PROPERTY_RETRY_TOPIC</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">correctTopic</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">backTopic</span> <span class="o">=</span> <span class="n">correctTopic</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">this</span><span class="o">.</span><span class="na">brokerController</span><span class="o">.</span><span class="na">getBrokerStatsManager</span><span class="o">().</span><span class="na">incSendBackNums</span><span class="o">(</span><span class="n">requestHeader</span><span class="o">.</span><span class="na">getGroup</span><span class="o">(),</span> <span class="n">backTopic</span><span class="o">);</span>

                <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

                <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SYSTEM_ERROR</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="n">putMessageResult</span><span class="o">.</span><span class="na">getPutMessageStatus</span><span class="o">().</span><span class="na">name</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">response</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">ResponseCode</span><span class="o">.</span><span class="na">SYSTEM_ERROR</span><span class="o">);</span>
    <span class="n">response</span><span class="o">.</span><span class="na">setRemark</span><span class="o">(</span><span class="s">&quot;putMessageResult is null&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
消息重试会创建一个新的主题-&ldquo;%RETRY%+consumerGroup&rdquo;, 然后根据新的主题获取TopicConfig，如果TopicConfig为空，则返回异常信息。</p>
<p>delayLevel表示延迟级别，如果msg的重试次数超过最大的重试次数（maxReconsumeTimes，默认16次）或者 delayLevel &lt; 0, 则消息不会进行重试，直接扔到死信队列。但是在实际业务场景下，不会重试那么多次，一般重试3次没有成功，就不需要再重试了，用户可以自定义处理该条消息。</p>
<p>delayLevel值一般为0（表示broker端控制重试次数），-1（表示不重试，直接入死信队列），&gt; 0（客户端控制重试次数）；</p>
<p><img alt="重试次数和延迟控制" src="/2019/01/15/rocketmq之consumer消息消费者/Users/jiangmingli/learning/ljm516.github.io/source/_posts/reconsumer_delay.jpg"></p>
<p>然后会构建 MessageExtBrokerInner 对象之后，会将消息入盘。入盘的逻辑在MessageStore.putMessage方法实现。</p>
<p>在入盘的时候，针对重试的消息，RocketMq有个名为<code>SCHEDULE_TOPIC_XXXX</code>的主题，对应一个ScheduleMessageService服务处理这些消息。这个服务在MessageStore启动的时候启动的。下面看看这个服务如何对消息进行重试。</p>
<p><strong>ScheduleMessageService.start()</strong>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">delayLevelTable</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Integer</span> <span class="n">level</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="n">Long</span> <span class="n">timeDelay</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span> <span class="c1">// 延迟执行时间</span>
        <span class="n">Long</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">offsetTable</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">level</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">offset</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">timeDelay</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timer</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="n">DeliverDelayedMessageTimerTask</span><span class="o">(</span><span class="n">level</span><span class="o">,</span> <span class="n">offset</span><span class="o">),</span> <span class="n">FIRST_DELAY_TIME</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">timer</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="n">TimerTask</span><span class="o">()</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">ScheduleMessageService</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">persist</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;scheduleAtFixedRate flush exception&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="mi">10000</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">defaultMessageStore</span><span class="o">.</span><span class="na">getMessageStoreConfig</span><span class="o">().</span><span class="na">getFlushDelayOffsetInterval</span><span class="o">());</span>
<span class="o">}</span>
</pre></div></p></article></body></html>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://ljm516.github.io/2019/01/15/rocketmq之consumer消息消费者/" data-id="cjr4rs1jx0037y1s6g3ubsq99" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/01/06/rocketmq之consumer消息消费者/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">rocketmq之consumer消息消费者</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/BigData/">BigData</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息队列/">消息队列</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/经历/">经历</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ORM/">ORM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/">RocketMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/broker/">broker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/consumer/">consumer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/producer/">producer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scrapy/">scrapy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试题/">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MySQL/" style="font-size: 12.5px;">MySQL</a> <a href="/tags/ORM/" style="font-size: 10px;">ORM</a> <a href="/tags/RocketMQ/" style="font-size: 15px;">RocketMQ</a> <a href="/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/tags/broker/" style="font-size: 10px;">broker</a> <a href="/tags/consumer/" style="font-size: 10px;">consumer</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/producer/" style="font-size: 10px;">producer</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/scrapy/" style="font-size: 17.5px;">scrapy</a> <a href="/tags/爬虫/" style="font-size: 20px;">爬虫</a> <a href="/tags/设计模式/" style="font-size: 12.5px;">设计模式</a> <a href="/tags/面试/" style="font-size: 10px;">面试</a> <a href="/tags/面试题/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/15/rocketmq之consumer消息消费者/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/01/06/rocketmq之consumer消息消费者/">rocketmq之consumer消息消费者</a>
          </li>
        
          <li>
            <a href="/2019/01/03/rocketmq之producer消息发送者/">rocketmq之producer消息发送者</a>
          </li>
        
          <li>
            <a href="/2018/12/28/rocketmq之broker源码学习/">rocketmq之broker源码学习</a>
          </li>
        
          <li>
            <a href="/2018/11/05/sparkTransformation-Actions/">spark transformation 和 actions 操作</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 lijianmging<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>