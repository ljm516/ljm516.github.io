---
title: python爬虫_part6_scrapy架构学习
date: 2018-02-27 22:44:39
categories: python
tags:
- 爬虫
- scrapy 
---

这里记录 Scrapy 架构的介绍，及其工作流程。

<!--more-->

## Scrapy 核心架构

 ![Scrapy 架构](Scrapy 架构.png)

- Scrapy 引擎
- 调度器
- 下载器
- 下载中间件
- spider
- 爬虫中间件
- 实体管道

### 详解

### Scrapy 引擎

是整个 Scrapy 架构的核心。负责控制整个数据的处理流程，以及触发一些事物处理。对各项组件进行控制及协调。

### 调度器

主要实现存储待爬取的网址，并确定这些网址的优先级，决定下一次爬取那个网址。

### 下载器

主要实现对网络上要爬取的页面资源进行高速下载，由于该组件需要通过网络进行大量数据的传输，所以该组件的压力负担一般会比其他组件中。

### 下载中间件

是处于下载器和 Scrapy 引擎之间的一个特定的组件，主要用于对下载器和 Scrapy 引擎之间的通信进行处理，在下载中间件中，可以加入自定义代码，轻松地实现 Scapy 功能的扩展。加入的自定义代码，会在 Scrapy 引擎与下载器通信的时候调用。

### Spiders

也叫爬虫组件，是 Scrapy 框架中爬虫实现的核心。在一个 Scrapy 项目中，可以用多个 spider，每个 spider 可以负责一个或多个特定的网站。

### 爬虫中间件

是处于 Scrapy 引擎与爬虫组件之间的一个特定的组件，主要用于对爬虫组件和 Scrapy 引擎之间的通信进行处理。也可以在爬虫中间件加入一些自定义的代码，实现 Scrapy 功能的扩展。 加入的自定义代码，在 Scrapy 引擎与爬虫组件之间进行通信的时候调用。

### 实体管道

主要用于接收 spider 组件中提取出来的元素，接收后，会对这些元素进行对应的处理，如: 清洗， 验证， 存储等。

## Scrapy 工作流

 ![Scrapy 工作流](Scrapy 工作流.png)

首先， Scrapy 引擎会将爬虫文件中设置的要爬取的起始网址（默认在 start_urls 属性中设置）传递到调度器中。随后执行 1-13 步骤。

1. 主要将下一次要爬取的网址传递给 Scrapy 引擎，调度器是一个优先队列，里面可能存储着多个要爬取的网址（也有可能是一个），调度器会根据各网址的优先级分析出下一次要爬取的网址，然后再传递给 Scrapy 引擎。
2. Scrapy 引擎接收到 1 中传过来的网址之后，过程 2 Scrapy 引擎主要将网址传递给下载中间件。
3. 下载中间件，接收到 Scrapy 引擎传过来的网址之后，过程 3 中下载中间件会将对应的网址传递给下载器。
4. 然后，下载器接收到对应要下载的网址，然后过程 4 会向互联网对应的网址发送 request 请求，进行网页下载。
5. 互联网中对应的网址接收到 request 请求后，会有相应的 response 响应，随后在过程 5 中将响应返回给下载器。
6. 下载器接收响应之后，即完成了对应网页的下载，随后过程 6 会将对应的响应传递给下载中间件。
7. 下载中间件接收到对应响应后，会与 Scrapy 引擎进行通信，过程 7 会将对应的 response 响应传递给 Scrapy 引擎。
8. Scrapy 引擎接收到 reponse 响应之后，过程 8 Scrapy 引擎会将 response 响应信息传递给爬虫中间件。
9. 爬虫中间件接收到对应响应之后，过程 9 爬虫中间件会将响应传递给对应的爬虫进行处理。
10. 爬虫进行处理之后，大致会有两方面的信息: 提取出来的数据和新的请求信息。然后，过程 10 爬虫会将处理后的信息传递给爬虫中间件。
11. 爬虫中间件接收到爬虫处理后的信息之后，过程 11 会将对应信息传递到 Scrapy 引擎。
12. 会同时进行过程 12 和 过程 13。 在过程 12 中，Scrapy 引擎会将提取出来的元素传递给实体管道，由实体管道对提取出来的信息进行进一步的处理: 过程 13 中，Scrapy 引擎会将爬虫处理后得到的新的信息传递给调度器，由调度器进行进一步网址的调度。

随后，再重复执行 1-13 步骤，一直到调度器中没有网址调度或者异常退出为止。


