---
title: çº¿ç¨‹åŸºç¡€
date: 2019-10-20 00:52:42
categories: Java
tags:
- å¤šçº¿ç¨‹
---
javaçº¿ç¨‹åŸºç¡€çŸ¥è¯†ç‚¹ã€‚

<!--more    -->
## çº¿ç¨‹
åœ¨ç†è§£çº¿ç¨‹æ± ä¹‹å‰ï¼Œå…ˆäº†è§£çº¿ç¨‹çš„ç›¸å…³çŸ¥è¯†ã€‚
### åˆ›å»ºçº¿ç¨‹
javaä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¾ˆç®€å•ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹:

```java
Thread t = new Thread();
//ä½†æ˜¯è¿™æ ·çº¿ç¨‹tä¸ä¼šåšä»»ä½•äº‹æƒ…ï¼Œå¯åŠ¨åç«‹é©¬å°±ç»“æŸäº†(è¿˜æ²¡å¼€å§‹å°±ç»“æŸäº†)ã€‚æ‰€ä»¥æˆ‘ä»¬è¦é‡å†™å®ƒçš„runæ–¹æ³•ã€‚
Thread t = new Thread() {
    @Override
    public void run() {
        System.out.println("hello + " + Thread.currentThread().getName());
    }
};
t.start();
```

åˆæˆ–è€…è¯´å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œé›†æˆRunableæ¥å£ï¼ŒRunableæ¥å£åªæœ‰ä¸€ä¸ªrunæ–¹æ³•ã€‚ç„¶åå°†è¿™ä¸ªç±»ä¼ å…¥åˆ°Threadçš„æ„é€ å‡½æ•°é‡Œï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨runæ–¹æ³•ã€‚ 

```java
public class Task implements Runnable {
    @Override
    public void run() {
        System.out.println("hello " + Thread.currentThread().getName());
    }
}
Thread t = new Thread(new Task());
```

æ³¨æ„ï¼Œä¸ç”¨é€šè¿‡è°ƒç”¨run()æ–¹æ³•å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œrun()æ–¹æ³•åªæ˜¯ä¼šä¸²è¡Œçš„è¿è¡Œrun()æ–¹æ³•çš„é€»è¾‘ã€‚

### çº¿ç¨‹ç»ˆæ­¢
ä»Threadç±»çš„apiå¯ä»¥çœ‹åˆ°ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªstop()æ–¹æ³•æ¥ç»ˆæ­¢å½“å‰çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹å¼è¢«æ ‡æ³¨ä¸ºåºŸå¼ƒã€‚è¿™æ˜¯å› ä¸ºstop()æ–¹æ³•æ¥ç»ˆæ­¢çº¿ç¨‹å¤ªè¿‡æš´åŠ›ï¼Œæœ‰å¯èƒ½å¼•å‘æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚

```java
public class UnsafeStopThreadSample {
    static User user = new User();

    public static void main(String[] args) throws InterruptedException {
        Thread readThread = new Thread(new ReadTask());
        readThread.start();
        while (true) {
            WriteThread writeThread = new WriteThread();
            writeThread.start();
            Thread.sleep(150);
            writeThread.stopMe();
        }
    }

    public static class ReadTask implements Runnable {

        @Override
        public void run() {
            while (true) {
                synchronized (user) {
                    if (user.getAge() != Integer.parseInt(user.getName())) {
                        System.out.println("age: " + user.getAge() + ";name:" + user.getName());
                    }
                }
                Thread.yield();
            }
        }
    }

    public static class WriteThread extends Thread {

        // æ­£ç¡®çš„åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„æ–¹æ³•
        volatile boolean stop = false;
        public void stopMe() {
            stop = true;
        }

        @Override
        public void run() {
            while (true) {
                if (stop) {
                    System.out.println("Thread-" + Thread.currentThread().getName() + " exit");
                }
                synchronized (user) {
                    int v = (int) (System.currentTimeMillis() / 1000);
                    user.setAge(v);
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    user.setName(String.valueOf(v));
                }
                Thread.yield();
            }
        }
    }
    @Data
    public static class User {
        int age;
        String name;

        public User() {
            this.age = 0;
            this.name = "0";
        }
    }
}
```
### çº¿ç¨‹ä¸­æ–­

çº¿ç¨‹ä¸­æ–­å¹¶ä¸ä¼šæ˜¯çº¿ç¨‹ç«‹å³é€€å‡ºï¼Œè€Œæ˜¯ç»™çº¿ç¨‹å‘é€ä¸€ä¸ªé€šçŸ¥ï¼Œå‘ŠçŸ¥ç›®æ ‡çº¿ç¨‹ï¼Œæœ‰äººå¸Œæœ›ä½ é€€å‡ºã€‚æœ‰å…³çº¿ç¨‹ä¸­æ–­

æœ‰ä¸ªä¸‰ä¸ªæ–¹æ³•:

```java
// ä¸­æ–­çº¿ç¨‹ï¼Œè®¾ç½®ä¸­æ–­æ ‡å¿—ä½
public void Thread.interrupt(); 
// åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œé€šè¿‡ä¸­æ–­æ ‡å¿—ä½åˆ¤æ–­
public boolean Thread.isInterrupted(); 
// åˆ¤æ–­æ˜¯å¦è¢«ä¸­æ–­ï¼Œå¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€
public static boolean Thread.interrupted();
```

**ä¸¾ä¸ªğŸŒ°:**

```java
public class ThreadInterrupt {

    public static void main(String[] args) throws InterruptedException {
        //testInterrupt();
        testSleepInterrupt();
    }

    public static void testSleepInterrupt() throws InterruptedException {
        Thread t = new Thread(() -> {
            while (true) {
                if (Thread.currentThread().isInterrupted()) {
                    System.out.println(Thread.currentThread().getName() + " exit");
                    break;
                }
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    // sleepè¢«ä¸­æ–­æŠ›å‡ºå¼‚å¸¸ï¼Œä¸­æ–­æ ‡å¿—ä½è¢«æ¸…é™¤ï¼Œæ‰€æœ‰çº¿ç¨‹ä¸ä¼šé€€å‡º
                    System.out.println("Interrupted when sleep");
                    // è¦ä¿è¯sleepè¢«ä¸­æ–­ï¼Œçº¿ç¨‹é€€å‡ºï¼Œéœ€è¦è®¾ç½®ä¸­æ–­æ ‡å¿—
                    Thread.currentThread().interrupt();
                }
                Thread.yield();
            }
        });
        t.start();
        Thread.sleep(2000);
        t.interrupt();
    }

    public static void testInterrupt() throws InterruptedException {
        Thread t = new Thread(() -> {
            while (true) {
                if (Thread.currentThread().isInterrupted()) {
                    System.out.println(Thread.currentThread().getName() + " exit");
                    break;
                }
                Thread.yield();
            }
        });

        t.start();
        Thread.sleep(2000);
        t.interrupt(); // æ‰§è¡Œinterruptæ–¹æ³•ï¼Œè®¾ç½®ä¸­æ–­æ ‡å¿—ä½
    }
}
```

### wait å’Œ notify æ–¹æ³•
è¿™ä¸¤ä¸ªæ–¹å¼ä¸æ˜¯Threadç±»çš„ï¼Œæ˜¯Objectç±»çš„ã€‚

å½“åœ¨ä¸€ä¸ªå¯¹è±¡å®ä¾‹ä¸Šè°ƒç”¨wait()æ–¹æ³•åï¼Œå½“å‰çº¿ç¨‹å°±ä¼šåœ¨è¿™ä¸ªå¯¹è±¡ä¸Šç­‰å¾…ã€‚åªè¦åœ¨å…¶ä»–çº¿ç¨‹çº¿ç¨‹è°ƒç”¨äº†notify()æ–¹æ³•ä¸ºæ­¢ï¼Œå½“å‰çº¿ç¨‹æ‰æœ‰å¯èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚

å·¥ä½œåŸç†:
> å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸ªobject.wait()æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¿›å…¥objectå¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå› ä¸ºç³»ç»Ÿè¿è¡Œå¤šä¸ªçº¿ç¨‹åŒæ—¶ç­‰å¾…æŸä¸ªå¯¹è±¡ã€‚å½“object.notify()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°±ä¼šä»è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶å°†å…¶å”¤é†’ã€‚è¿™é‡Œçš„é€‰æ‹©æ˜¯ä¸å…¬å¹³çš„ã€‚

å¯¹åº”çš„ï¼Œè¿˜æœ‰ä¸ªnotifyAll()æ–¹æ³•ï¼Œå®ƒä¼šå”¤é†’æ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è°ƒç”¨wait()æˆ–è€…notify()æ–¹æ³•å‰ï¼Œéœ€è¦è·å–åˆ°objectè¿™ä¸ªå¯¹è±¡é”ã€‚æ‰§è¡Œäº†wait()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾å¯¹è±¡é”ã€‚

wait()æ–¹æ³•å’Œsleep()æ–¹æ³•çš„åŒºåˆ«:
> wait()å’Œsleep()æ–¹æ³•éƒ½å¯ä»¥è®©çº¿ç¨‹ç­‰å¾…è‹¥å¹²æ—¶é—´ï¼Œwait()æ–¹æ³•å¯ä»¥è¢«å”¤é†’ï¼Œä¸”ä¼šé‡Šæ”¾ç›®æ ‡å¯¹è±¡çš„é”ã€‚

```java
public class ThreadWaitAndNotify {
    private static Object obj = new Object();

    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            synchronized (obj) {
                System.out.println("t1 get object lock: " + System.currentTimeMillis());
                try {
                    obj.wait();
                    System.out.println("t1 end: " + System.currentTimeMillis());
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });

        Thread t2 = new Thread(() -> {
            synchronized (obj) {
                System.out.println("t2 get object lock: " + System.currentTimeMillis());
                obj.notify();
                try {
                    System.out.println("t2 end: " + System.currentTimeMillis());
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        t1.start();
        t2.start();
    }
}
```

### çº¿ç¨‹çš„æŒ‚èµ·(suspend)å’Œç»§ç»­æ‰§è¡Œ(resume)
è¢«æŒ‚èµ·çš„çº¿ç¨‹ï¼Œå¿…é¡»è¦ç­‰åˆ°resume()æ–¹æ³•æ‰§è¡Œä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚suspend()æ–¹æ³•åœ¨å¯¼è‡´çº¿ç¨‹æš‚åœåŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½•é”èµ„æºã€‚ä½¿ç”¨suspend()æ–¹æ³•éœ€è¦æ…é‡ï¼Œå¦‚æœé”™è¯¯çš„æ‰§è¡Œäº†resume()æ–¹æ³•(resumeåœ¨suspendå‰æ‰§è¡Œ)ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºè¿›å…¥æ­»é”çš„çŠ¶æ€ ã€‚å› ä¸ºçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½•é”èµ„æºï¼Œä¸”éœ€è¦çº¿ç¨‹æ‰§è¡Œresumeæ–¹æ³•æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

### ç­‰å¾…çº¿ç¨‹ç»“æŸ(join)å’Œè°¦è®©(yeild)
join()æ–¹æ³•è¡¨ç¤ºæ— é™ç­‰å¾…ï¼Œå®ƒä¼šä¸€ç›´é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚yeild()æ–¹æ³•ç»™å‡ºä¸€ä¸ªæœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡ç»™å®šæ—¶é—´ç›®æ ‡çº¿ç¨‹è¿˜åœ¨æ‰§è¡Œï¼Œå½“å‰çº¿ç¨‹ä¼šå› ä¸ºç­‰å¾…è¶…æ—¶ï¼Œè€Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚

```java
public class ThreadJoinAndYeild {

    volatile static int i= 0;

    public static void main(String[] args) throws InterruptedException {
        AddThread t = new AddThread();
        t.start();

        // å¦‚æœåœ¨è¿™é‡Œä¸æ‰§è¡Œjoinæ–¹æ³•ï¼Œè¾“å‡ºçš„iå¯èƒ½æ˜¯0æˆ–è€…æ˜¯ä¸€ä¸ªéå¸¸å°çš„æ•°
        t.join();
        System.out.println(i);
    }

    static class AddThread extends Thread {
        @Override
        public void run() {
            for (i=0; i < 10000; i++);
        }
    }
}
```

yeild()æ–¹æ³•ä¸€æ—¦æ‰§è¡Œï¼Œå®ƒä¼šä½¿å¾—å½“å‰çº¿ç¨‹è®©å‡ºcpuã€‚è®©å‡ºä¹‹åå¹¶ä¸ä»£è¡¨å½“å‰çº¿ç¨‹ä¸æ‰§è¡Œäº†ï¼Œå½“å‰çº¿ç¨‹è®©å‡ºcpuåï¼Œè¿˜ä¼šè¿›è¡Œcpuèµ„æºäº‰å¤ºï¼Œä½†æ˜¯èƒ½ä¸èƒ½åˆ†é…åˆ°èµ„æºå°±ä¸ä¸€å®šäº†ã€‚

### çº¿ç¨‹ä¼˜å…ˆçº§
Javaä¸­ä½¿ç”¨1åˆ°10è¡¨ç¤ºçº¿ç¨‹ä¼˜å…ˆçº§ã€‚ä¸€èˆ¬å¯ä»¥ä½¿ç”¨å†…ç½®çš„ä¸‰ä¸ªé™æ€æ ‡é‡è¡¨ç¤º:

```java
/**
 * The minimum priority that a thread can have.
 */
public final static int MIN_PRIORITY = 1;

/**
 * The default priority that is assigned to a thread.
 */
public final static int NORM_PRIORITY = 5;

/**
 * The maximum priority that a thread can have.
 */
public final static int MAX_PRIORITY = 10;
```

æ•°å­—è¶Šå¤§åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ‰é™èŒƒå›´åœ¨1åˆ°10ä¹‹é—´ï¼Œé»˜è®¤ä¸º5ï¼›

```java
public class ThreadPriority {

    private static Object obj = new Object();
    private static double lowFaster = 0;
    private static double highFaster = 0;
    private volatile static long lowFinishTime = 0;
    private volatile static long highFinishTime = 0;
    public static void main(String[] args) throws InterruptedException {
        int runTimes = 100;
        for (int i = 0; i < runTimes; i++) {
            PriorityThread high = new PriorityThread();
            high.setPriority(Thread.MAX_PRIORITY);
            high.setName("highPriorityThread");

            PriorityThread low = new PriorityThread();
            low.setPriority(Thread.MIN_PRIORITY);
            low.setName("lowPriorityThread");

            low.start();
            high.start();

            low.join();
            high.join();
            
            // è®°å½•ä¸åŒä¼˜å…ˆçº§å…ˆå®Œæˆçš„æ¬¡æ•°ï¼Œç„¶åä½œå¯¹æ¯”
            if (lowFinishTime - highFinishTime > 0) {
                lowFaster ++;
            } else {
                highFaster ++;
            }
        }

        System.out.println(lowFaster / runTimes);
        System.out.println(highFaster / runTimes);
    }

    static class PriorityThread extends Thread {
        static int count = 0;

        @Override
        public void run() {
            while (count > 10000) {
                synchronized (obj) {
                    count++;
                }
            }
            System.out.println(Thread.currentThread().getName() + " finished job");
            // ç®€å•çš„è®°å½•å®Œæˆjodçš„æ—¶é—´ç‚¹
            if (Thread.currentThread().getName().equalsIgnoreCase("lowPriorityThread")) {
                lowFinishTime = System.currentTimeMillis();
            } else {
                highFinishTime = System.currentTimeMillis();
            }
        }
    }
}
```













